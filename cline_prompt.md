AIサービスの改善を行いましょう
- システムプロンプトの後にfirstMessageTemplateというプロパティを追加したのでAIリクエストのhistoryの先頭に加えてください。
- すべてのstepを読み込んで
  - 全体ではどのようなステップがあって、いまどのステップなのかをプロンプトに含めてください
 - このステップより前の成果物をすべてプロンプトに追加してください。

------

ProjectTemplateのStep内にあるuserChoicePromptTemplateを廃止し、最初の一言目を話すfirstMessageTemplateを追加してください。このテンプレートは、AIが最初にユーザーに送信するメッセージを定義します。この変更に伴い、EditViewの処理を修正してください。

------

サーバ側でJSONパースエラーが出ています。今回はPoCなのでプロンプトとAIレスポンスをdebugログに出すようにしましょう。可能であればCloudRunの構造化ログに対応させてください。

------

すべてのAPIはPOSTなのですが、GETで実装されてしまっています。修正してください。
/api/chat/streamからSSEを使ってただしくレスポンスが返ってきているのですが、processAIStreamのほうで適切に取得できていないようです。SSEの場合は別の書き方が必要ですか？

------

functions/配下のコードをCloudrunにするためserver/配下に移植しましたが、実際の処理があまりかけていませんでした。まず
/api/chat/stream
をchatWithContextから処理を追って移植しましょう

------

cloudfunctionを使用していた個所をすべてCloudRunに統合しました。ベースのパスは
env.SERVER_BASE_URLで指定しています。
で、そこから先のエンドポイントはserver.tsを参照して、DetailViewで使用しているJSを書き変えてください。

------

cloud functions for firebaseで書いてきましたが、処理が多くなってきたのでCloud Runに変更しようと思います。functions関連パッケージを除去し、Cloud Runでhttp2のstreaming reponse（SSE）が返せるようにDockerfileを構築し、server.tsを設置してください。

------

DetailViewについて、チャットの吹き出しと成果物の表示についてはmarkdown形式をプレビューしたいので、必要なライブラリを導入して適切にプレビュー表示できるようにしてください。markdownのプリセットとしてはGithub flavoredがいいですね。

------

長くなってきたので、テンプレートとJSを分離しましょうか。

------

DetailViewで成果物の表示が、ブラウザのアラートみたいになっているので、Tailwindでモーダル表示にしてもらえますか

------

firestoreのデータ構造を、users/project/stepsのstepsおよびusers/projectTemplates/stepsのstepsをサブコレクションに変更したのですが、やっぱりprojectTemplatesのstepsはプロパティにするべきだと思い直しました。この変更に伴い、template/CreateView.vueとtemplate/EditView.vueを修正してください。また、DetailView.vueのProjectTemplateRefを使う部分を修正してください。型定義のfirestore.tsは修正済みです。

------

firestoreのデータ構造をリファクタリングしたいです。users/projests/stepsあるいはusers/projectTemplates/stepsのStepが、いずれも親ドキュメントのプロパティとなっていますが、これをサブコレクションにかえたいです。併せて参照している個所をすべて適切に書き変えたいです（DetailViewはProject/Stepsのみ変更済み）

------
updateAIMessageでレスポンスが帰ってきたら、exampleResponseを呼び出してください。このAPIはサーバー側でこれまでのconversationsを読み込んだうえで、ユーザーが回答を思い付かないときのためにサンプルで短い質問の例をJSON配列で返します。

------

DetailViewで、Projectの中のStepの中のConversationを読み書きする部分で、ProjectRefを使うのは冗長ではないでしょうか

------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用した専門家ユーザー（例：マーケティングコンサルタント）と顧客ユーザー間の共同プロジェクトのためのWebアプリケーションです。開発時のルールを整備したいので、既存ファイル群を見てルールを整理してください。なお、環境設定に関しては除外して構いません。新しく参加した開発者がこのプロジェクトを理解できるよう簡潔にまとめてください。
記述は.clinerulesファイルにmarkdown形式で英語でまとめてください。

--------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIとやり取りを行うAPIをfunctions/src/index.tsに3つ作りました。

 - システムプロンプト、選択済みのファイルを使ったチャットAI
 - チャットが行われた後、AIの問いかけに対して人間がうまく答えられなかった場合に、直近の会話とユーザー選択肢プロンプトを利用した回答例AI
 - 会話履歴と成果物指示のプロンプトを元に成果物を生成するAI

それぞれのURLは以下の通りです。

Function URL (chatWithContext(us-west1)): https://us-west1-tuned-ai-prod.cloudfunctions.net/chatWithContext
Function URL (generateExampleResponse(us-west1)): https://us-west1-tuned-ai-prod.cloudfunctions.net/generateExampleResponse
Function URL (generateArtifact(us-west1)): https://us-west1-tuned-ai-prod.cloudfunctions.net/generateArtifact

これらのAIと通信するクライアントサイドの実装をDetailViewで進めてください。なお、stram形式でのレスポンスのため、fetchで呼び出すことを想定しています。
後ほどAPIを変更して認証ヘッダを検証する予定なので今はまだ検証していませんが通信時には認証ヘッダを追加してください。

--------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用した専門家ユーザー（例：マーケティングコンサルタント）と顧客ユーザー間の共同プロジェクトのためのWebアプリケーションです。Vueのファイル群はsrcのなかにあります。PoCのため一人のユーザーが専門家としても顧客ユーザーとしても機能するためRoleなどはありません。

現在、AIとスムーズに共同作業するためのプロジェクトテンプレートおよび、テンプレートから作成したプロジェクトを管理する機能を実装しています。プロジェクトテンプレートは、ステップごとにAIとの対話を行い、成果物を生成するためのプロンプトを定義します。プロジェクトは、プロジェクトテンプレートを元に作成され、各ステップでAIと対話しながら進行します。

そこで、AI（Gemini）と通信を行うためのAPIエンドポイントを作成してください。APIエンドポイントは、AIとの対話を行い、成果物を生成するためのプロンプトを提供します。まずはプロジェクトの各ステップに対して、AIとの対話を行うためのAPIエンドポイントを作成してください。

 - システムプロンプト、選択済みのファイルを使ったチャットAI
 - 直近の会話とユーザー選択肢プロンプトを利用した回答例AI
 - 会話履歴と成果物指示のプロンプトを元に成果物を生成するAI

 フロントの改修は不要なので、まずはAPIエンドポイントのみ作成してください。AIのレスポンスはstreamで行いたいので、クライアントサイドからはfetchで呼び出す想定です。

--------

プロジェクト画面（DetailView）の実装を進めましょう。作成済みのプロジェクト詳細画面では、本来プロジェクトテンプレートから読み込む部分がハードコードされています。プロジェクトテンプレートのIDをもとに、プロジェクトテンプレートの内容を読み込むようにしてください。また、ＣＳＳ調整によりヘッダーがfixedになったので上部が一部隠れているのも直しましょう。

プロジェクトのCreateについても修正が必要です。実際のプロジェクトを選択できるようにしてください。
具体的には、DashboardViewにプロジェクトの新規作成ボタンがありますが、この場所ではなく、各プロジェクトテンプレートのカードの中に、このテンプレートを選択してプロジェクトを作成するUIがあるべきです。
Createにはただしくプロジェクトテンプレートが選択された状態でプロジェクトを作成できるように、またヘッダーのCSSの修正も適応する必要があります。

--------
プロジェクトテンプレートの編集に2点編集を加えましょう。
・共通ヘッダーは、画面がスクロールしても追従して常に表示するようCSSを変更してください。
・ステップ名称を編集可能にしてください。

--------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用した専門家ユーザー（例：マーケティングコンサルタント）と顧客ユーザー間の共同プロジェクトのためのWebアプリケーションです。Vueのファイル群はsrcのなかにあります。

ProjectTemplateのStepにファイルをアップロードすることをトリガーに、ファイルの内容を判別してPDFまたはテキストファイルから文字列を抽出するcloud functionsを書いてください。抽出したテキストは、firestoreのProjectTemplateのStepの当該referenceDocumentsのプロパティとして保存してください。

--------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用した専門家ユーザー（例：マーケティングコンサルタント）と顧客ユーザー間の共同プロジェクトのためのWebアプリケーションです。Vueのファイル群はsrcのなかにあります。

ProjectをProjectemplateと同様にdb rootからuserコレクション配下に移動してください。

--------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用した専門家ユーザー（例：マーケティングコンサルタント）と顧客ユーザー間の共同プロジェクトのためのWebアプリケーションです。Vueのファイル群はsrcのなかにあります。PoCのため一人のユーザーが専門家としても顧客ユーザーとしても機能するためRoleなどはありません。

ファイルアップロード機能を作りましょう。先にIDを発番しておいた方が都合がいいので、Createの段階ではステップの追加及はできないようにしてください。新規作成時はEditに遷移するようにしましょう。また、Editではステップの追加時にfirestoreのIDを発番しておいて、そのIDをもとにファイルアップロードを行うようにしてください。
ファイルアップロードはfirebase storageにセキュリティルールを使ってクライアントサイドから直接アップロードできるようにしてください。firestoreにはファイルのIDを先に発番しておいて、そのIDをもとにファイルをアップロードしてください。

--------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用した専門家ユーザー（例：マーケティングコンサルタント）と顧客ユーザー間の共同プロジェクトのためのWebアプリケーションです。Vueのファイル群はsrcのなかにあり、routerはrouter/index.jsに記述してあります。PoCのため一人のユーザーが専門家としても顧客ユーザーとしても機能するためRoleなどはありません。

mockデータおよびfirestoreの型設定を行いました。そこで、現在Vueファイルに直接ダミーデータを書き込んでいますが、これをプロジェクト一覧、作成、編集（＝詳細）を直接firestoreを読み書きするように機能追加してください。AIの返答部分及びファイルアップロード部分はあとでAPIを作成するのでいまは無視して固定データを使って構いません。なお、プロジェクトの作成とはプロジェクトテンプレートを選択して新規プロジェクトを作成することを指します。編集及び詳細画面は同じ画面を指し、事前に用意されたテンプレートに沿って各ステップごとにAIと会話し成果物を作成していきます。

---------

いくつかサンプルで画面を作ったのですが、CSSが冗長になってきました。ここまで作成したvueテンプレートをチェックしてCSSをリファクタリングしてmain.cssに統合してください。似ているが若干違うようなパーツはできるだけ統一してください。

---------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用した専門家ユーザー（例：マーケティングコンサルタント）と顧客ユーザー間の共同プロジェクトのためのWebアプリケーションです。Vueのファイル群はsrcのなかにあり、routerはrouter/index.jsに記述してあります。PoCのため一人のユーザーが専門家としても顧客ユーザーとしても機能するためRoleなどはありません。

firestoreの型設定を参考に、Googleログインしたユーザをfirestoreに登録するよう機能開発してください。

---------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用した専門家ユーザー（例：マーケティングコンサルタント）と顧客ユーザー間の共同プロジェクトのためのWebアプリケーションです。Vueのファイル群はsrcのなかにあり、routerはrouter/index.jsに記述してあります。PoCのため一人のユーザーが専門家としても顧客ユーザーとしても機能するためRoleなどはありません。

mockデータおよびfirestoreの型設定を行いました。そこで、現在Vueファイルに直接ダミーデータを書き込んでいますが、これをプロジェクトテンプレート一覧、作成、編集を直接firestoreを読み書きするように機能追加してください。

---------

（プロジェクト基本情報を流用）
このような要件があるときに、Firestoreのスキーマ設計及び、ローカルテストするときのためのモックデータjsonファイルを作成してください。

プロジェクトテンプレートも公開されるまでは自分しか見れないようにしましょう。そう考えると一覧取得の容易さからみて、サブコレクションにすべきでしょうか？
また、公開プロジェクトテンプレートコレクションを別途作成し、publishした時だけ自身のテンプレートをコピーして持たせてはどうでしょうか。

---------


このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用したユーザー（例：マーケティングコンサルタント）とユーザー間の共同プロジェクトのためのWebアプリケーションです。Vueのファイル群はsrcのなかにあり、routerはrouter/index.jsに記述してあります。各画面のレスポンシブになる際の画面全体のレイアウトに対するメディアクエリがおかしいようです。Tailwindにおいて、PC=lg、タブレット=md、スマホ=それ以下となるように点検してください。

-----------

このプロジェクトはVue.js 3とFirebaseを使用して開発されます。AIを活用したユーザー（例：マーケティングコンサルタント）とユーザー間の共同プロジェクトのためのWebアプリケーションです。PoCのため一人のユーザーがユーザーとしても通常ユーザーとしても機能します。画面のモックアップを作ったので、Firebase Authによるログイン機能を実装してください。Vueのファイル群はsrcのなかにあり、routerはrouter/index.jsに記述してあります。画面のモックアップは
LoginView.vueにあります。ログイン後は/dashboardに遷移してください。

----------


以下は、AIを活用したユーザー（例：マーケティングコンサルタント）とユーザー間の共同プロジェクトのためのWebアプリケーションの設計と実装に関する要件です。Vue.js 3とFirebaseを使用して開発します。PoCのため一人のユーザーがユーザーとしても通常ユーザーとしても機能します。

**全体的な機能:**

*   ユーザーは、複数ステップのAIチャットフローで構成されるプロジェクトテンプレートを作成します。
*   ユーザーは、プロジェクトテンプレートからプロジェクトを開始します。
*   ユーザーは、AIと対話しながら、プロジェクトを進めます。

**プロジェクトテンプレートの機能:**

*   **プロジェクトテンプレート作成:** ユーザーは、プロジェクトテンプレートをステップのシーケンスとして定義できます。各ステップには以下が含まれます。
    *   AIシステムプロンプト
    *   ユーザーが入力に困った場合に、あらかじめ用意された選択肢を提供するオプションのプロンプト
    *   そのステップ内のチャット履歴に基づいて成果物を生成するプロンプト。これらの成果物は、後続のステップで参照できます。
    *   プロジェクトのすべてのステップでアクセス可能なドキュメントをアップロードする機能

**プロジェクト機能:**

*   ユーザーは、プロジェクトテンプレートを使用してプロジェクトを開始します。
*   ユーザーは、既存のプロジェクトからステップをコピーして新しいプロジェクトを作成することもできます。

**ユーザーインターフェース（画面）:**

 *   トップページ兼ログインページ
 *   ダッシュボード（プロジェクトテンプレート一覧、プロジェクト一覧、ログアウト）
 *   プロジェクトテンプレート作成
 *   プロジェクトテンプレート編集
 *   プロジェクトテンプレート削除
 *   プロジェクト詳細

**プロジェクト詳細画面UI:**

*   **左カラム:** ステップをメイン項目として表示します。ステップをクリックすると、中央と右のカラムにその内容が表示されます。各ステップ名称の下段には、成果物の存在を示すアイコンと、短い要約（最大15文字）が表示されます。
*   **中央カラム:** AIプロンプトと、ユーザーがAIと対話するためのチャット入力フォームが含まれます。各ステップごとに用意した、定型文をフィルするためのボタンも表示されます。
*   **右カラム:**
    *   上部：現在のステップに関連するドキュメント（プロジェクト全体または前のステップから）を表示し、AIコンテキストに提供するかどうかを制御するオン/オフのトグル付き。また、アップロードを受け付けるボタンも表示します。
    *   下部：現在のステップで生成された成果物を表示します。タイトルと文字数の要約が表示され、クリックするとモーダルで全文が表示されます。

**データ構造:**

*   ユーザー
*   プロジェクトテンプレート
    *   ユーザーID
    *   ステップ（配列）
        *   AIシステムプロンプト
        *   ユーザー選択肢プロンプト
        *   固定参照ドキュメントをテキスト化したもの[]
        *   成果物生成のためのプロンプト
*   プロジェクト
    *   プロジェクトテンプレートID
    *   ステップ（配列）
        *   ユーザー入力[]
        *   AI応答[]
        *   生成された成果物テキスト
        *   参照ドキュメントの使用状況[]
        *   ステップ専用にアップされたドキュメントをテキスト化したもの[]

**AI統合:**

*   基盤となるAIモデルとしてGeminiを使用します。

**具体的な実装ガイダンス（オプション）:**

*   PoCのためできるだけ部品に分割せず、少ないファイル数でシンプルなアーキテクチャを使用してください。
*   明確で直感的なユーザーインターフェースを優先してください。

**成果物:**

まずは、firebaseプロジェクトを作成し、hosting側にvue3を読み込み、ロジックを一切書かずに画面だけ作成してください。

*   データベーススキーマ（マイグレーション）
*   Firebaseモデルとリレーションシップ
*   主要な画面（例：プロジェクト詳細）の基本的なReactコンポーネント
*   APIエンドポイント（該当する場合）
*   アプリケーションアーキテクチャと主要な機能を概説するドキュメント

このプロンプトは、アプリケーションの要件の包括的な概要を提供します。適切に構造化され、保守しやすいコードベースを提供してください。

